---
title: 登录的前后端合作
tags: [Cookie, JavaScript, Nodejs]
date: 2021-01-25 21:15:07
categories:
- 计算机
- 前端
---

# 从创建用户到用户登录
1. 用户注册。由前端的页面得到用户信息然后将需要的用户注册信息传给后端。
2. 创建用户。后端拿到前端的用户信息之后，进行数据库的信息比对，如果信息无误，则插入到数据库。这里需要知道的是前端可以选择是否要进行字段合法性检测，后端必须要检查字段是否合法，因为用户可以通过curl直接访问网站而不经过浏览器页面。
3. 用户登录。用户输入用户名和密码之后，点击登录按钮，前端将用户输入的信息提交给后端，后端拿到信息之后进行比对，如果用户名密码正确的话则允许登录，否则给出提示。
4. 登录信息保存。浏览器使用Cookie来存储用户信息，如果你需要保持用户的登录状态，那么后端需要在用户登录成功之后将用户登录信息保存在Cookie里。
5. 在页面展示用户信息。后端使用nodejs获取Cookie，然后通过Cookie的唯一字段去数据库里寻找需要展示的字段信息，将字段信息返回给前端，前端根据返回的信息进行页面展示。

# 开始写

## 先写一个登录页面

## 登录页面发请求
```
$("#signUpForm").on("submit", (e) => {
    e.preventDefault()
    let hash = {}
    let keys = ['userName', 'email', 'password', 'passwordComformation']
    keys.forEach((key) => {
        hash[key] = $("#signUpForm").find(`[name=${key}]`).val()
    })
    $.ajax({
        url: '/signUp',
        method: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(hash),
        error: function () {
        console.log("error");
        },
        success: function () {
        console.log("success");
        }
    })
})
```

## nodejs获取前端发送的请求
因为数据是一点一点发送的，得到的是Buffer对象，要转成json格式
```
request.on('data', chunk => {
    let json = JSON.parse(chunk.toString())
    console.log(json)
});
```

## 数据合法性检测
这个demo里我们需要检测的是email是否符合要求、以及password和passwordConfirmation是否匹配。前后端使用同一个约定字符串，后端负责返回错误类型，前端对这个错误类型进行解释说明并呈现给用户。

## 弄一个数据库
因为是做一个demo，所以这里我们创建data.db文件作为一个简单的数据库。格式如下：
```
[{
    "userName": "xxx",
    "email": "aaa@bbb.cn",
    "password": "cc"
}]
```
实际使用的时候，密码应该是加密存储，但是这里先不做那些。

## 往数据库里添加数据
先读取数据文件，然后再往这个文件后面追加东西，再把数据写到数据文件里。
```
let users = fs.readFileSync('./database.db', 'utf8')
users = JSON.parse(users)
users.push({
    "userName": userName, 
    "email": email,
    "password": password
})
let userStr = JSON.stringify(users)
fs.writeFileSync('./database.db', userStr)
```

## 对添加进数据库的数据进行筛选
用户发送的数据可能是不对的，我们之前进行了数据本身的校验，但除此之外，大部分时候我们还需要将新的数据与数据库里其他的数据进行比较，这里我们设置注册邮箱必须唯一。
读取数据库文件，然后对其进行遍历，如果邮箱地址存在则返回400，给出提示；如果不存在的话就将注册用户信息填入数据库并返回success。

